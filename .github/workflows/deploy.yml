# =============================================================================
# CI/CD Pipeline para Nurturing Backend (Laravel)
# Despliega a Google Cloud Run
# =============================================================================
#
# Triggers:
#   - Push a 'staging' -> Deploy a QA
#   - Push a 'main'    -> Deploy a Producci√≥n
#
# Secretos requeridos en GitHub:
#   - GCP_PROJECT_ID: ID del proyecto en GCP
#   - GCP_SA_KEY: JSON key de la Service Account
#   - GCP_REGION: Regi√≥n (ej: southamerica-east1)
#
# =============================================================================

name: Deploy Backend to Cloud Run

on:
  push:
    branches:
      - staging
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'qa'
        type: choice
        options:
          - qa
          - production

env:
  # Artifact Registry
  GAR_LOCATION: ${{ secrets.GCP_REGION }}
  REPOSITORY: nurturing-images
  IMAGE_NAME: nurturing-api

jobs:
  # ===========================================================================
  # Job: Test (TEMPORALMENTE DESHABILITADO - tests cuelgan en CI)
  # ===========================================================================
  # test:
  #   name: Run Tests
  #   runs-on: ubuntu-latest
  #   ... (deshabilitado temporalmente)

  # ===========================================================================
  # Job: Build and Deploy
  # ===========================================================================
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    # needs: test  # Deshabilitado temporalmente
    
    # Determinar ambiente basado en branch o input manual
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'qa') }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        id: env
        run: |
          if [ "${{ env.ENVIRONMENT }}" == "production" ]; then
            echo "SERVICE_NAME=nurturing-api-prod" >> $GITHUB_OUTPUT
            echo "CLOUD_SQL_INSTANCE=${{ secrets.GCP_PROJECT_ID }}:${{ secrets.GCP_REGION }}:nurturing-db" >> $GITHUB_OUTPUT
            echo "ENV_SUFFIX=prod" >> $GITHUB_OUTPUT
            echo "DB_NAME=nurturing" >> $GITHUB_OUTPUT
          else
            echo "SERVICE_NAME=nurturing-api-qa" >> $GITHUB_OUTPUT
            echo "CLOUD_SQL_INSTANCE=${{ secrets.GCP_PROJECT_ID }}:${{ secrets.GCP_REGION }}:nurturing-db" >> $GITHUB_OUTPUT
            echo "ENV_SUFFIX=qa" >> $GITHUB_OUTPUT
            echo "DB_NAME=nurturing" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev --quiet

      - name: Build Docker image
        run: |
          docker build \
            --tag "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" \
            --tag "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest-${{ steps.env.outputs.ENV_SUFFIX }}" \
            --build-arg ENVIRONMENT=${{ env.ENVIRONMENT }} \
            .

      - name: Push Docker image
        run: |
          docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          docker push "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest-${{ steps.env.outputs.ENV_SUFFIX }}"

      - name: Set Sanctum domains
        id: sanctum
        run: |
          if [ "${{ env.ENVIRONMENT }}" == "production" ]; then
            echo "STATEFUL_DOMAINS=app.nurturing.segal.cl,api.nurturing.segal.cl" >> $GITHUB_OUTPUT
            echo "FRONTEND_URL=https://app.nurturing.segal.cl" >> $GITHUB_OUTPUT
            echo "API_URL=https://api.nurturing.segal.cl" >> $GITHUB_OUTPUT
            echo "SESSION_DOMAIN=.nurturing.segal.cl" >> $GITHUB_OUTPUT
            echo "CORS_ORIGINS=https://app.nurturing.segal.cl" >> $GITHUB_OUTPUT
          else
            echo "STATEFUL_DOMAINS=nurturing-qa.segal.cl,api-nurturing-qa.segal.cl" >> $GITHUB_OUTPUT
            echo "FRONTEND_URL=https://nurturing-qa.segal.cl" >> $GITHUB_OUTPUT
            echo "API_URL=https://api-nurturing-qa.segal.cl" >> $GITHUB_OUTPUT
            echo "SESSION_DOMAIN=.segal.cl" >> $GITHUB_OUTPUT
            echo "CORS_ORIGINS=https://nurturing-qa.segal.cl" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ steps.env.outputs.SERVICE_NAME }} \
            --image "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" \
            --region ${{ secrets.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --memory 512Mi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --timeout 300 \
            --vpc-connector projects/${{ secrets.GCP_PROJECT_ID }}/locations/${{ secrets.GCP_REGION }}/connectors/nurturing-connector \
            --vpc-egress all-traffic \
            --set-env-vars "^||^APP_ENV=${{ env.ENVIRONMENT }}||APP_DEBUG=${{ env.ENVIRONMENT == 'qa' && 'true' || 'false' }}||APP_URL=${{ steps.sanctum.outputs.API_URL }}||LOG_CHANNEL=stderr||AUTO_MIGRATE=true||DB_CONNECTION=pgsql||DB_HOST=/cloudsql/${{ steps.env.outputs.CLOUD_SQL_INSTANCE }}||DB_PORT=5432||DB_DATABASE=${{ steps.env.outputs.DB_NAME }}||DB_USERNAME=postgres||SANCTUM_STATEFUL_DOMAINS=${{ steps.sanctum.outputs.STATEFUL_DOMAINS }}||SESSION_DOMAIN=${{ steps.sanctum.outputs.SESSION_DOMAIN }}||SESSION_DRIVER=cookie||CORS_ALLOWED_ORIGINS=${{ steps.sanctum.outputs.CORS_ORIGINS }}||FRONTEND_URL=${{ steps.sanctum.outputs.FRONTEND_URL }}||MAIL_MAILER=smtp||MAIL_HOST=fast.smtpok.com||MAIL_PORT=1025||MAIL_USERNAME=s146066_5||MAIL_PASSWORD=HBBMg+gji1||MAIL_ENCRYPTION=null||MAIL_FROM_ADDRESS=notificaciones@segal.cl||MAIL_FROM_NAME=Notificaciones Segal||GOOGLE_CLOUD_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}||GOOGLE_CLOUD_STORAGE_BUCKET=nurturing-imports-qa||FILESYSTEM_DISK=gcs||QUEUE_CONNECTION=database" \
            --set-secrets "APP_KEY=nurturing-${{ steps.env.outputs.ENV_SUFFIX }}-app-key:latest,DB_PASSWORD=nurturing-${{ steps.env.outputs.ENV_SUFFIX }}-db-password:latest" \
            --add-cloudsql-instances ${{ steps.env.outputs.CLOUD_SQL_INSTANCE }}

      - name: Get Cloud Run URL
        run: |
          URL=$(gcloud run services describe ${{ steps.env.outputs.SERVICE_NAME }} \
            --region ${{ secrets.GCP_REGION }} \
            --format 'value(status.url)')
          echo "## üöÄ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ steps.env.outputs.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** $URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.IMAGE_NAME }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job: Notify (opcional)
  # ===========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Notify on success
        if: needs.deploy.result == 'success'
        run: |
          echo "‚úÖ Deployment successful!"
          # Aqu√≠ podr√≠as agregar notificaci√≥n a Slack, Discord, etc.
          
      - name: Notify on failure
        if: needs.deploy.result == 'failure'
        run: |
          echo "‚ùå Deployment failed!"
          # Aqu√≠ podr√≠as agregar notificaci√≥n a Slack, Discord, etc.
